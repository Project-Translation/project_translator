
# 项目翻译器

一个易于使用的 VSCode 扩展，用于项目的多语言本地化。

项目仓库：`https://github.com/Project-Translation/project_translator`

## 安装

1. 市场：
   - VS Code 扩展市场：[https://marketplace.visualstudio.com/items?itemName=techfetch-dev.project-translator](https://marketplace.visualstudio.com/items?itemName=techfetch-dev.project-translator)
   - Open VSX 注册表：[https://open-vsx.org/extension/techfetch-dev/project-translator](https://open-vsx.org/extension/techfetch-dev/project-translator)
2. 在 VS Code 扩展视图中搜索 `techfetch-dev.project-translator` 并点击安装

<!-- ![example1](../resources/example1.gif) -->
![example1](https://i.imgur.com/uwRal2I.gif)

## 可用翻译

该扩展支持翻译为以下语言：

- [简体中文 (zh-cn)](./README.zh-cn.md)
- [繁體中文 (zh-tw)](./README.zh-tw.md)
- [日本語 (ja-jp)](./README.ja-jp.md)
- [한국어 (ko-kr)](./README.ko-kr.md)
- [Français (fr-fr)](./README.fr-fr.md)
- [Deutsch (de-de)](./README.de-de.md)
- [Español (es-es)](./README.es-es.md)
- [Português (pt-br)](./README.pt-br.md)
- [Русский (ru-ru)](./README.ru-ru.md)
- [العربية (ar-sa)](./README.ar-sa.md)
- [العربية (ar-ae)](./README.ar-ae.md)
- [العربية (ar-eg)](./README.ar-eg.md)

## 示例项目

| 项目                                                                             | 原始仓库                                                                                       | 描述                                                                                                                                                               | 星标 | 标签                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| ----------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| [algorithm-visualizer](https://github.com/Project-Translation/algorithm-visualizer) | [algorithm-visualizer/algorithm-visualizer](https://github.com/algorithm-visualizer/algorithm-visualizer) | :fireworks:从代码可视化算法的交互式在线平台                                                                                                                               | 47301 | [`algorithm`](https://github.com/topics/algorithm), [`animation`](https://github.com/topics/animation), [`data-structure`](https://github.com/topics/data-structure), [`visualization`](https://github.com/topics/visualization)                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| [algorithms](https://github.com/Project-Translation/algorithms)                     | [algorithm-visualizer/algorithms](https://github.com/algorithm-visualizer/algorithms)                     | :crystal_ball:算法可视化                                                                                                                                                  | 401   | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| [cline-docs](https://github.com/Project-Translation/cline-docs)                     | [cline/cline](https://github.com/cline/cline)                                                             | 集成在您 IDE 中的自主编码代理，能够在您的逐步许可下创建/编辑文件、执行命令、使用浏览器等。                                                                                | 39572 | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| [cursor-docs](https://github.com/Project-Translation/cursor-docs)                   | [getcursor/docs](https://github.com/getcursor/docs)                                                       | Cursor 的开源文档                                                                                                                                                         | 309   | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| [gobyexample](https://github.com/Project-Translation/gobyexample)                   | [mmcgrana/gobyexample](https://github.com/mmcgrana/gobyexample)                                           | Go 语言示例                                                                                                                                                               | 7523  | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| [golang-website](https://github.com/Project-Translation/golang-website)             | [golang/website](https://github.com/golang/website)                                                       | [镜像] go.dev 和 golang.org 网站的主页                                                                                                                                     | 402   | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| [reference-en-us](https://github.com/Project-Translation/reference-en-us)           | [Fechin/reference](https://github.com/Fechin/reference)                                                   | ⭕ 分享开发者的快速参考速查表。                                                                                                                                            | 7808  | [`awk`](https://github.com/topics/awk), [`bash`](https://github.com/topics/bash), [`chatgpt`](https://github.com/topics/chatgpt), [`cheatsheet`](https://github.com/topics/cheatsheet), [`cheatsheets`](https://github.com/topics/cheatsheets), [`css`](https://github.com/topics/css), [`golang`](https://github.com/topics/golang), [`grep`](https://github.com/topics/grep), [`markdown`](https://github.com/topics/markdown), [`python`](https://github.com/topics/python), [`reference`](https://github.com/topics/reference), [`sed`](https://github.com/topics/sed), [`snippets`](https://github.com/topics/snippets), [`vim`](https://github.com/topics/vim) |
| [styleguide](https://github.com/Project-Translation/styleguide)                     | [google/styleguide](https://github.com/google/styleguide)                                                 | Google 开源项目的风格指南                                                                                                                                                 | 38055 | [`cpplint`](https://github.com/topics/cpplint), [`style-guide`](https://github.com/topics/style-guide), [`styleguide`](https://github.com/topics/styleguide)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| [vscode-docs](https://github.com/Project-Translation/vscode-docs)                   | [microsoft/vscode-docs](https://github.com/microsoft/vscode-docs)                                         | Visual Studio Code 的公共文档                                                                                                                                             | 5914  | [`vscode`](https://github.com/topics/vscode)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |

## 请求项目翻译

如果您想贡献翻译或需要翻译某个项目：

1. 使用以下模板创建 issue：

```md
**项目**: [project_url]
**目标语言**: [target_lang]
**描述**: 简要说明此翻译的价值
```

2. 工作流程：

```mermaid
sequenceDiagram
  Contributor->>Project Translator: 创建翻译 issue
  Project Translator->>Community: 审核 issue
  Community-->>Contributor: 批准/评论
  Contributor->>New Project: 开始翻译
  Contributor->>New Project: 提交到新项目
  Contributor->>Project Translator: 创建 Pull Request，修改 README.Samples
  Project Translator-->>Project Translator: 审核并合并
```

3. PR 合并后，翻译将被添加到示例部分。

当前进行中的翻译：[查看 Issues](https://github.com/Project-Translation/project_translator/issues)

## 功能特性

- 📁 文件夹级翻译支持
  - 将整个项目文件夹翻译为多种语言
  - 保持原始文件夹结构和层级
  - 支持递归翻译子文件夹
  - 自动检测可翻译内容
  - 批量处理高效进行大规模翻译
- 📄 文件级翻译支持
  - 将单个文件翻译为多种语言
  - 保持原始文件结构和格式
  - 同时支持文件夹和文件翻译模式
- 💡 智能 AI 翻译
  - 自动保持代码结构完整性
  - 仅翻译代码注释，保留代码逻辑
  - 保持 JSON/XML 等数据结构格式
  - 专业级技术文档翻译质量
- ⚙️ 灵活配置
  - 配置源文件夹和多个目标文件夹
  - 支持自定义文件翻译间隔
  - 设置特定文件类型忽略
  - 支持多种 AI 模型选项
- 🚀 用户友好操作
  - 实时显示翻译进度
  - 支持暂停/恢复/停止翻译
  - 自动维护目标文件夹结构
  - 增量翻译避免重复工作
- 🔄 差异翻译（实验性）
  - 差异应用模式高效更新现有翻译
  - 仅翻译变更内容减少 API 使用
  - 最小化编辑保留版本历史
  - ⚠️ 实验性功能 - 详见[高级功能](#差异翻译diff-apply模式)

## 配置

该扩展支持以下配置选项：

```json
{
  "projectTranslator.specifiedFolders": [
    {
      "sourceFolder": {
        "path": "源文件夹路径",
        "lang": "源语言代码"
      },
      "targetFolders": [
        {
          "path": "目标文件夹路径",
          "lang": "目标语言代码"
        }
      ]
    }
  ],
  "projectTranslator.specifiedFiles": [
    {
      "sourceFile": {
        "path": "源文件路径",
        "lang": "源语言代码"
      },
      "targetFiles": [
        {
          "path": "目标文件路径",
          "lang": "目标语言代码"
        }
      ]
    }
  ],
  "projectTranslator.currentVendor": "openai",
  "projectTranslator.vendors": [
    {
      "name": "openai",
      "apiEndpoint": "API 端点 URL",
      "apiKeyEnvVarName": "MY_OPENAI_API_KEY",
      "model": "gpt-4o",
      "rpm": "10",
      "maxTokensPerSegment": 4096,
      "timeout": 180,
      "temperature": 0.1
    }
  ],
  "projectTranslator.userPrompts": [
      "1. 如果 Markdown 文件的前置数据（front matter）中 'draft' 设置为 'true'，则应返回无需翻译。",
      "2. 句子中的 './readmes/' 应替换为 './'",
  ],
  "projectTranslator.ignore": {
    "paths": [
      "**/node_modules/**"
    ],
    "extensions": [
      ".log"
    ]
  },
}
```

关键配置详情：

| 配置选项                        | 描述                                                                                    |
| ------------------------------------------- | ---------------------------------------------------------------------------------------------- |
| `projectTranslator.specifiedFolders`        | 多个源文件夹及其对应的目标文件夹用于翻译           |
| `projectTranslator.specifiedFiles`          | 多个源文件及其对应的目标文件用于翻译               |
| `projectTranslator.translationIntervalDays` | 翻译间隔天数（默认 7 天）                                                  |
| `projectTranslator.copyOnly`                | 仅复制不翻译的文件（包含 `paths` 和 `extensions` 数组）                         |
| `projectTranslator.ignore`                  | 完全忽略的文件（包含 `paths` 和 `extensions` 数组）                              |
| `projectTranslator.skipFrontMatterMarkers`  | 基于前置数据标记跳过文件（包含 `enabled` 和 `markers` 数组）                 |
| `projectTranslator.currentVendor`           | 当前使用的 API 供应商                                                                      |
| `projectTranslator.vendors`                 | API 供应商配置列表（可直接使用 apiKey 或通过 apiKeyEnvVarName 使用环境变量） |
| `projectTranslator.systemPromptLanguage`    | 内置系统提示使用的语言（默认：en）。影响模型指令方式，不影响 UI 语言 |
| `projectTranslator.systemPrompts`           | 指导翻译过程的系统提示数组                                        |
| `projectTranslator.userPrompts`             | 用户自定义提示数组，这些提示将在翻译时添加到系统提示之后 |
| `projectTranslator.segmentationMarkers`     | 按文件类型配置的分段标记，支持正则表达式                     |
| `projectTranslator.debug`                   | 启用调试模式将所有 API 请求和响应记录到输出通道（默认：false）     |
| `projectTranslator.logFile`                 | 调试日志文件配置（参见[日志文件功能](./docs/log-file-feature.md)）         |
| `projectTranslator.diffApply.enabled`       | 启用实验性差异翻译模式（默认：false）                             |

## 使用方法

1. 打开命令面板 (Ctrl+Shift+P / Cmd+Shift+P)
2. 输入 "Translate Project" 并选择命令
3. 如果源文件夹未配置，将出现文件夹选择对话框
4. 等待翻译完成

翻译过程中：

- 可通过状态栏按钮暂停/恢复翻译
- 可随时停止翻译进程
- 翻译进度显示在通知区域
- 详细日志显示在输出面板

## 开发

### 构建系统

该扩展使用 esbuild 进行快速打包和开发：

#### 可用脚本

- `npm run build` - 生产构建（最小化）
- `npm run compile` - 开发构建
- `npm run watch` - 开发监视模式
- `npm test` - 运行测试

#### VS Code 任务

- **Build** (Ctrl+Shift+P → "Tasks: Run Task" → "build") - 为生产环境打包扩展
- **Watch** (Ctrl+Shift+P → "Tasks: Run Task" → "watch") - 开发模式自动重建

### 开发设置

1. 克隆仓库
2. 运行 `npm install` 安装依赖
3. 按 `F5` 开始调试或运行 "watch" 任务进行开发

esbuild 配置：

- 将所有 TypeScript 文件打包为单个 `out/extension.js`
- 排除 VS Code API（标记为外部）

## 高级功能

### 使用环境变量存储 API 密钥

项目翻译器支持使用环境变量存储 API 密钥，这比直接在配置文件中存储密钥更安全：

1. 为供应商配置 `apiKeyEnvVarName` 属性：

```json
{
  "projectTranslator.vendors": [
    {
      "name": "openai",
      "apiEndpoint": "https://api.openai.com/v1",
      "apiKeyEnvVarName": "OPENAI_API_KEY",
      "model": "gpt-4"
    },
    {
      "name": "openrouter",
      "apiEndpoint": "https://openrouter.ai/api/v1",
      "apiKeyEnvVarName": "OPENROUTER_API_KEY",
      "model": "anthropic/claude-3-opus"
    }
  ]
}
```

2. 在系统中设置环境变量：
   - Windows：`set OPENAI_API_KEY=your_api_key`
   - macOS/Linux：`export OPENAI_API_KEY=your_api_key`

3. 扩展运行时将：
   - 首先检查配置中是否直接提供了 `apiKey`
   - 如果没有，则查找 `apiKeyEnvVarName` 指定的环境变量

这种方法可以避免 API 密钥出现在配置文件或版本控制系统中。

### 基于前置数据跳过翻译

项目翻译器可以根据 Markdown 文件的前置数据元数据跳过翻译。这对于草稿文档或标记为无需翻译的文件非常有用。

要启用此功能，配置 `projectTranslator.skipFrontMatterMarkers` 选项：

```json
{
  "projectTranslator.skipFrontMatterMarkers": {
    "enabled": true,
    "markers": [
      {
        "key": "draft",
        "value": "true"
      },
      {
        "key": "translate",
        "value": "false"
      }
    ]
  }
}
```

使用此配置后，任何包含 `draft: true` 或 `translate: false` 前置数据的 Markdown 文件将在翻译过程中被跳过，并直接复制到目标位置。

示例会被跳过的 Markdown 文件：
```
---
draft: true
title: "草稿文档"
---

本文档是草稿，不应翻译。
```

### 差异翻译（Diff-Apply）模式

> **⚠️ 实验性功能警告**：差异翻译模式目前是实验性功能，可能存在稳定性和兼容性问题。建议在生产环境中谨慎使用，并始终备份重要文件。

该扩展支持可选的差异翻译模式（diff-apply）。启用后，扩展将源内容和现有翻译的目标文件同时发送给模型。模型应返回一个或多个 SEARCH/REPLACE 块（纯文本，无代码围栏）。扩展在本地应用这些块以最小化更改、减少 API 使用并更好地保留版本历史。

- **切换**：在 VS Code 设置或 `project.translation.json` 中配置 `projectTranslator.diffApply.enabled`（默认：`false`）。
- **选项**：
  - `validationLevel`：`normal` 或 `strict`（默认：`normal`）。在 `strict` 模式下，无效标记或匹配失败将导致错误，扩展将回退到标准翻译流程。
  - `autoBackup`：如果为 true，在应用编辑前创建目标文件的 `.bak` 备份（默认：`true`）。
  - `maxOperationsPerFile`：（保留兼容性）新策略未使用。

工作流程：
1. 如果 `diffApply.enabled` 为 `true` 且目标文件存在，扩展读取源内容和目标内容。
2. 使用差异提示调用模型，并要求返回纯文本 SEARCH/REPLACE 块。
3. 扩展解析并应用 SEARCH/REPLACE 块。如果应用失败，则回退到正常完整翻译并覆盖目标文件。

示例 SEARCH/REPLACE（允许多个块）：

```
<<<<<<< SEARCH
:start_line: 10
-------
const label = "Old"
=======
const label = "New"
>>>>>>> REPLACE

<<<<<<< SEARCH
:start_line: 25
-------
function foo() {
  return 1
}
=======
function foo() {
  return 2
}
>>>>>>> REPLACE
```

注意事项：
- 在 SEARCH 部分使用精确内容（包括缩进和空格）。如果不确定，请使用最新文件内容。
- 在 SEARCH 和 REPLACE 之间保留单行 `=======`。
- 如果无需更改，模型应返回空字符串。

为什么当前差异翻译效果不佳（解释）

- **跨语言对齐和比较挑战**：差异翻译需要将原始源文档和现有翻译文档同时发送给模型，模型必须跨语言比较它们以决定翻译的哪些部分需要更改。这本质上比就地修改单个文档更困难，因为模型必须准确对齐不同语言的片段并判断语义差异。

- **格式和边界保存的复杂性**：许多文档包含代码块、表格、前端标记或特殊占位符。可靠的差异工作流必须在进行文本编辑时保留这些结构。如果模型不能始终如一地生成严格遵循 SEARCH/REPLACE 格式的结果，自动应用编辑可能会引入格式退化或结构错误。

- **上下文和术语一致性问题**：小的局部编辑通常依赖于更广泛的上下文和现有的术语/风格词汇表。当要求生成最小编辑时，模型可能忽略全局一致性（术语、风格、注释、变量名），导致翻译不一致或语义偏移。

- **模型稳定性和成本权衡**：实现可靠的差异翻译需要具有强大比较推理能力和稳定、可预测输出格式的模型。当前主流模型无法以合理成本同时提供稳健的跨语言对齐和严格格式化的输出，因此系统通常会回退到完整重译以确保正确性。

因此，虽然差异翻译理论上可以减少昂贵的输出令牌并更好地保留版本历史，但目前受限于模型的跨语言比较能力和输出稳定性。此功能仍为实验性；建议的缓解措施包括保持自动备份（`autoBackup: true`）、使用宽松的验证级别（`validationLevel: "normal"`）以及在匹配或格式化失败时回退到完整重译。未来，专业的双语对齐后处理器或定制的小型模型可能会提高差异方法的稳定性。

成本节省及其帮助

- **输入与输出令牌成本**：大型模型 API 通常对输入（提示）和输出（补全）令牌收取不同费用。通常，输出令牌明显更昂贵，因为模型生成了更长的文本。差异应用有帮助，因为我们发送**更新的源（输入）**和**现有翻译文件（输入）**给模型，并要求返回紧凑的编辑 JSON。模型的响应是一个小 JSON（少量输出令牌），而不是完整的重译文件（大量输出令牌），因此您为昂贵的输出部分支付的费用要少得多。

- **仅发送变更内容**：差异应用不是在小变更发生时重新翻译整个文件，而是指示模型计算更新现有翻译的最小编辑操作。这对于先前已翻译且仅接收增量编辑的文件特别有效。

- **最适合格式化文件**：具有严格格式的文件（JSON、XML、带代码块的 Markdown）受益显著，因为差异应用保留结构，仅更改需要翻译的文本部分。这减少了格式相关退化和模型重新格式化导致的额外输出令牌的可能性。

- **面向行的基本单元，更智能的聚合**：该工具将基本翻译单元视为"行"，SEARCH/REPLACE 策略在 `:start_line:` 附近应用精确或模糊匹配。使用 `validationLevel: "normal"` 获得宽容行为，`"strict"` 用于需要保守精确编辑时。

何时使用差异应用：

- 当目标文件已存在且先前已翻译时使用。
- 用于大型格式化文档，重新翻译整个文件成本高昂时使用。
- 避免用于全新无先前翻译的文件，或需要全新重译时。

### 设计文档

- 为开发构建生成源映射
- 为生产构建最小化代码
- 提供 VS Code 问题匹配器集成

## 注意事项

- 确保足够的 API 使用配额
- 建议先使用小型项目测试
- 使用专用 API 密钥并在完成后移除

## 许可证

[许可证](LICENSE)