# AGENTS.md

This file provides guidance to agents when working with code in this repository.

## 项目架构规则（仅非显而易见部分）

### 核心架构决策
- **扩展架构**：VSCode扩展，不是独立应用，依赖VSCode生命周期
- **翻译决策机制**：基于文件哈希、时间间隔和多重缓存的智能决策系统
- **流式处理**：支持流式和非流式两种翻译模式，适应不同场景需求

### 关键组件关系
- **FileProcessor**：核心文件处理逻辑，协调翻译、缓存和文件操作
- **TranslatorService**：AI API交互层，处理流式/非流式翻译和特殊返回码
- **TranslationDatabase**：翻译历史管理，提供智能缓存和决策支持
- **LogFileManager**：调试日志管理，支持文件轮转和详细记录

### 隐藏的耦合关系
- **缓存依赖链**：`translationDecisionCache` → `noTranslateCache` → `vendorLastRequest`
- **状态管理**：全局状态通过extension.ts管理，影响所有服务组件
- **配置传播**：配置变更需要同步到多个服务实例
- **取消机制**：CancellationToken需要贯穿整个调用链

### 性能瓶颈识别
- **大文件处理**：分块逻辑可能成为性能瓶颈，需要优化token估算
- **缓存失效**：5分钟缓存策略在高频更新场景下可能不够优化
- **并发限制**：RPM限制在多文件并发时可能成为瓶颈
- **磁盘I/O**：频繁的缓存读写可能影响性能

### 扩展性约束
- **供应商限制**：必须兼容OpenAI API格式，新供应商需要适配
- **文件格式**：分词标记系统需要为每种文件类型定制
- **语言支持**：语言代码验证限制为<10字符的任意字符串
- **VSCode依赖**：强依赖VSCode API，难以移植到其他平台

### 数据流设计
```
用户操作 → FileProcessor → 缓存检查 → TranslatorService → AI API
     ↓                                ↓
翻译数据库 ← 文件写入 ← 特殊返回码处理 ← 响应处理
```

### 关键设计模式
- **策略模式**：不同翻译供应商的配置和API调用
- **观察者模式**：配置变更通知和状态更新
- **工厂模式**：翻译服务的创建和初始化
- **命令模式**：用户操作的封装和执行

### 架构演进考虑
- **微服务化**：翻译服务可独立为微服务
- **插件化**：文件处理器可支持插件扩展
- **分布式**：缓存系统可支持分布式存储
- **异步优化**：大规模文件处理可进一步异步化