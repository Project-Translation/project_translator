name: Publish Extension

on:
  push:
    # 推送任意 tag 时触发（例如 0.16.1 或 v0.16.1）
    tags:
      - "*"

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          # 使用 GitHub Actions 提供的最新 LTS 版本
          node-version: 'lts/*'
          
      - name: Install dependencies
        run: npm install
        
      - name: Build
        run: npm run build
        
      - name: Package Extension
        run: npm run package --baseContentUrl https://github.com/Project-Translation/project_translator/tree/main

      - name: Publish to Visual Studio Marketplace
        run: |
          npx @vscode/vsce publish --pat ${{ secrets.VSCE_PAT }}
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

  publish-ovsx:
    name: Publish to Open VSX
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          # 使用 GitHub Actions 提供的最新 LTS 版本
          node-version: 'lts/*'

      - name: Install dependencies
        run: npm install

      - name: Build
        run: npm run build

      - name: Package Extension
        run: npm run package --baseContentUrl https://github.com/Project-Translation/project_translator/tree/main

      - name: Publish to Open VSX Registry
        env:
          OPEN_VSX_TOKEN: ${{ secrets.OPEN_VSX_TOKEN }}
        run: |
          npm run publish:ovsx
